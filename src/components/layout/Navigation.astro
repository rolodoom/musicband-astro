---
// Import JSON data
import navigationData from "@/data/navigation.json";
import bandData from "@/data/band.json";
import { Icon } from "astro-icon/components";

const { navItems } = navigationData;
const { bandName } = bandData;
---

<nav
  class="fixed top-0 right-0 left-0 z-50 bg-transparent transition-all duration-300"
  id="mainNav"
>
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div
      class="flex h-20 items-center justify-between transition-all duration-300"
      id="navContainer"
    >
      <!-- Logo -->
      <a href="#top" class="transition-all duration-300">
        <img
          src="/images/navbar-logo.svg"
          alt={bandName}
          id="logoImg"
          class="h-8 transition-all duration-300"
        />
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex md:space-x-8">
        {
          navItems.map((item) => (
            <a
              href={item.url}
              class="nav-link font-heading hover:text-primary text-md px-3 py-2 font-bold tracking-wider text-gray-300 uppercase transition-colors duration-300"
              data-section={item.url.substring(1)}
            >
              {item.label}
            </a>
          ))
        }
      </div>

      <!-- Mobile menu button -->
      <button
        id="menuBtn"
        class="relative rounded p-2 text-white hover:bg-white/10 md:hidden"
        aria-label="Toggle menu"
      >
        <!-- Hamburger -->
        <Icon name="fa7-solid:bars" size={24} id="menuIcon" />
      </button>
    </div>
  </div>
</nav>

<!-- Mobile Navigation Overlay -->
<div
  id="mobileMenu"
  class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm"
>
  <div class="absolute top-4 right-4">
    <button
      id="mobileCloseBtn"
      class="rounded p-2 text-white hover:bg-white/10"
      aria-label="Close menu"
    >
      <Icon
        name="fa7-solid:xmark"
        size={24}
        class="transition-opacity duration-300"
      />
    </button>
  </div>
  <div class="flex h-full flex-col items-center justify-center space-y-6">
    {
      navItems.map((item) => (
        <a
          href={item.url}
          class="mobile-nav-link font-heading hover:text-primary border-b border-white/10 px-3 py-4 text-lg font-bold tracking-wider text-white uppercase transition-colors duration-300"
          data-section={item.url.substring(1)}
        >
          {item.label}
        </a>
      ))
    }
  </div>
</div>

<script is:inline>
  // =====================================================
  // NAVBAR CONTROLLER
  // Compatible with Astro <ClientRouter />
  //
  // Key principles:
  // - Do NOT use DOMContentLoaded (fires only once)
  // - Re-query page-dependent elements after navigation
  // - Avoid duplicate event listeners
  // - Handle scroll restoration correctly
  // =====================================================

  function initNavbar() {
    // -------------------------------------------------
    // CORE ELEMENT REFERENCES (persistent - Layout)
    // -------------------------------------------------
    const nav = document.getElementById("mainNav");
    const navContainer = document.getElementById("navContainer");
    const logoImg = document.getElementById("logoImg");

    const menuBtn = document.getElementById("menuBtn");
    const mobileMenu = document.getElementById("mobileMenu");
    const mobileCloseBtn = document.getElementById("mobileCloseBtn");

    if (!nav || !navContainer || !logoImg) return;

    // -------------------------------------------------
    // Prevent duplicate initialization
    // (ClientRouter keeps JS runtime alive)
    // -------------------------------------------------
    if (nav.__navbarInitialized) return;
    nav.__navbarInitialized = true;

    // =================================================
    // MOBILE MENU
    // =================================================
    function openMenu() {
      mobileMenu.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function closeMenu() {
      mobileMenu.classList.add("hidden");
      document.body.style.overflow = "";
    }

    menuBtn?.addEventListener("click", () => {
      mobileMenu.classList.contains("hidden") ? openMenu() : closeMenu();
    });

    mobileCloseBtn?.addEventListener("click", closeMenu);

    mobileMenu?.addEventListener("click", (e) => {
      if (e.target === mobileMenu) closeMenu();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !mobileMenu.classList.contains("hidden")) {
        closeMenu();
      }
    });

    // =================================================
    // SCROLL BEHAVIOR (Shrink + Background)
    // =================================================
    function handleScrollAppearance() {
      if (window.scrollY > 50) {
        nav.classList.add("bg-dark/90", "backdrop-blur-sm");
        nav.classList.remove("bg-transparent");
        navContainer.classList.replace("h-20", "h-16");
        logoImg.classList.replace("h-8", "h-6");
      } else {
        nav.classList.remove("bg-dark/90", "backdrop-blur-sm");
        nav.classList.add("bg-transparent");
        navContainer.classList.replace("h-16", "h-20");
        logoImg.classList.replace("h-6", "h-8");
      }
    }

    // =================================================
    // ACTIVE LINK HIGHLIGHTING
    // IMPORTANT:
    // Sections are re-queried dynamically because
    // page content changes after navigation.
    // =================================================
    function updateActiveLink() {
      const navHeight = navContainer.offsetHeight;
      const sections = [...document.querySelectorAll("section[id]")];
      const navLinks = [
        ...document.querySelectorAll(".nav-link, .mobile-nav-link"),
      ];
      const scrollPos = window.scrollY + navHeight + 1;
      const pageBottom = window.scrollY + window.innerHeight;

      let current = null;

      for (let i = 0; i < sections.length; i++) {
        const section = sections[i];

        // Check if we are past the top of the section
        if (scrollPos >= section.offsetTop) {
          current = section;
        }

        // Special check: if we reach the bottom of the page, always highlight last section
        if (pageBottom >= document.body.scrollHeight) {
          current = sections[sections.length - 1];
        }
      }

      // Reset all links
      navLinks.forEach((link) => {
        link.classList.remove("text-primary");
        if (link.classList.contains("nav-link"))
          link.classList.add("text-gray-300");
        if (link.classList.contains("mobile-nav-link"))
          link.classList.add("text-gray-400");
      });

      // Highlight current
      if (current) {
        navLinks.forEach((link) => {
          if (link.dataset.section === current.id) {
            link.classList.remove("text-gray-300", "text-gray-400");
            link.classList.add("text-primary");
          }
        });
      }
    }

    // =================================================
    // SMOOTH SCROLL
    // (Re-attaches automatically since links persist)
    // =================================================
    function initSmoothScroll() {
      const navHeight = () => navContainer.offsetHeight;

      document.body.addEventListener("click", (e) => {
        const anchor = e.target.closest('a[href^="#"]');
        if (!anchor) return;
        const target = document.querySelector(anchor.getAttribute("href"));
        if (!target) return;

        e.preventDefault();

        const offset =
          target.getBoundingClientRect().top +
          window.scrollY -
          navContainer.offsetHeight;

        window.scrollTo({ top: offset, behavior: "smooth" });

        // Close mobile menu if open
        if (typeof closeMenu === "function") closeMenu();

        // Optional: update URL hash without jumping
        window.history.pushState(null, "", anchor.getAttribute("href"));
      });
    }

    // =================================================
    // GLOBAL SCROLL LISTENER
    // =================================================
    window.addEventListener("scroll", () => {
      requestAnimationFrame(() => {
        handleScrollAppearance();
        updateActiveLink();
      });
    });

    window.addEventListener("resize", () => {
      if (window.innerWidth >= 768) closeMenu();
    });

    // Initial state evaluation
    handleScrollAppearance();
    updateActiveLink();
    initSmoothScroll();
  }

  // =====================================================
  // LIFECYCLE HOOKS
  // =====================================================

  // First page load
  initNavbar();

  // Every Astro navigation
  document.addEventListener("astro:page-load", () => {
    // Recalculate page-dependent state
    const nav = document.getElementById("mainNav");
    if (!nav) return;

    // Re-run only dynamic parts
    const event = new Event("scroll");
    window.dispatchEvent(event);
  });
</script>
